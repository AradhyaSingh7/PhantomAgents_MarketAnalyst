<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Market Research Analyst</title>
  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: #1c1c1c;
      color: #e0e0e0;
      display: flex;
      min-height: 100vh;
    }
    /* Chat section */
    #chat-section {
      flex: 2;
      background: #2a2a2a;
      border-right: 1px solid #444;
      display: flex;
      flex-direction: column;
    }
    #chat-header {
      padding: 1.5rem;
      background: linear-gradient(180deg, #8b5cf6, #5b21b6);
      color: white;
      font-weight: bold;
      font-size: 1.75rem;
      text-align: center;
    }
    #messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    .msg {
      display: flex;
      margin-bottom: 1rem;
    }
    .msg.user {
      justify-content: flex-end;
    }
    .msg.bot {
      justify-content: flex-start;
    }
    .bubble {
      max-width: 70%;
      padding: 0.6rem 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    .bubble.user {
      background: #8b5cf6;
      color: white;
      margin-right: 0.5rem;
    }
    .bubble.bot {
      background: #333;
      color: #e0e0e0;
      margin-left: 0.5rem;
    }
    #chat-form {
      display: flex;
      padding: 0.5rem;
      border-top: 1px solid #444;
      background: #2a2a2a;
    }
    #chat-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #444;
      border-radius: 8px;
      background: #1c1c1c;
      color: #e0e0e0;
    }
    #send-btn {
      margin-left: 0.5rem;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 50%;
      padding: 0.5rem;
      cursor: pointer;
    }

    /* Loader */
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    .loader {
      display: flex;
      gap: 4px;
    }
    .loader span {
      width: 6px;
      height: 6px;
      background: #8b5cf6;
      border-radius: 50%;
      animation: bounce 1s infinite;
    }
    .loader span:nth-child(2) { animation-delay: 0.2s; }
    .loader span:nth-child(3) { animation-delay: 0.4s; }

    /* Graph section */
    #graph-section {
      flex: 1;
      padding: 2rem;
      background: #2a2a2a;
      border-radius: 8px;
      margin: 1rem;
    }
    #graph-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    canvas {
      background: #1c1c1c;
      border: 1px solid #444;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Chat Section -->
  <div id="chat-section">
    <div id="chat-header">Market Research Analyst</div>
    <div id="messages"></div>
    <form id="chat-form">
      <input id="chat-input" placeholder="Type your query..." />
      <button id="send-btn" type="submit">➤</button>
    </form>
  </div>

  <!-- Graph Section -->
  <div id="graph-section">
    <h2 id="graph-title">Company Feature Space</h2>
    <canvas id="scatterChart" width="400" height="400"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // Initial data
  const initialVectorData = [
    { x: -21.435, y: 3.223, type: 'Financials' },
    { x: -20.074, y: 4.124, type: 'Financials' },
    { x: -21.254, y: 5.048, type: 'Financials' },
    { x: -16.512, y: 1.890, type: 'Sentiment' },
    { x: -17.966, y: 3.738, type: 'Sentiment' },
    { x: -19.506, y: 6.867, type: 'Sentiment' },
    { x: -4.581, y: -3.741, type: 'Innovation' },
    { x: -6.664, y: -11.835, type: 'Innovation' },
    { x: -8.231, y: -9.567, type: 'Innovation' },
  ];

  const typeColors = {
    Financials: '#c084fc',
    Sentiment: '#4ade80',
    Innovation: '#22d3ee',
  };

  // Scatter chart setup
  const ctx = document.getElementById("scatterChart").getContext("2d");
  const scatterChart = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "Financials",
          data: initialVectorData.filter(d => d.type === "Financials"),
          backgroundColor: typeColors.Financials,
        },
        {
          label: "Sentiment",
          data: initialVectorData.filter(d => d.type === "Sentiment"),
          backgroundColor: typeColors.Sentiment,
        },
        {
          label: "Innovation",
          data: initialVectorData.filter(d => d.type === "Innovation"),
          backgroundColor: typeColors.Innovation,
        }
      ]
    },
    options: {
      responsive: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `Type: ${ctx.raw.type}, X: ${ctx.raw.x.toFixed(3)}, Y: ${ctx.raw.y.toFixed(3)}`
          }
        }
      },
      scales: {
        x: { title: { display: true, text: "X" } },
        y: { title: { display: true, text: "Y" } }
      }
    }
  });

  // Chat logic
  const messagesDiv = document.getElementById("messages");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");

  function addMessage(text, sender="bot") {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("msg", sender);

    const bubble = document.createElement("div");
    bubble.classList.add("bubble", sender);
    bubble.innerText = text;

    msgDiv.appendChild(bubble);
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  addMessage("Hello! I'm your AI Market Analyst. How can I help?", "bot");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    addMessage(text, "user");
    input.value = "";

    // Show loader
    const loader = document.createElement("div");
    loader.classList.add("loader");
    loader.innerHTML = "<span></span><span></span><span></span>";
    messagesDiv.appendChild(loader);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
      const response = await fetch("/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      if (!response.ok) throw new Error("Server error");
      const data = await response.json();

      loader.remove();

      // ✅ FIX: use backend's actual structure
      if (data.response) {
        addMessage(data.response, "bot");   // <-- plain string now

        // Update chart
        if (data.graph_plot) {
          scatterChart.data.datasets.forEach(ds => ds.data = []);
          data.graph_plot.forEach(d => {
            const ds = scatterChart.data.datasets.find(ds => ds.label === d.type);
            if (ds) ds.data.push(d);
          });
          scatterChart.update();
        }
      } else {
        addMessage("Invalid response format from backend.", "bot");
      }
    } catch (err) {
      loader.remove();
      addMessage("Sorry, I couldn't fetch the data.", "bot");
      console.error(err);
    }
  });
</script>

</body>
</html>
